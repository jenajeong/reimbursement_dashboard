<!DOCTYPE html>
{% load static %}
{% load humanize %}
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 수정</title>
    <link rel="stylesheet" href="/static/css/order/add_order.css"> 
    <style>
        /* 기존 스타일 유지 */
        .order-table-wrapper { margin-top: 15px; overflow-x: auto; }
        .order-table { width: 100%; border-collapse: collapse; border-spacing: 0; font-size: 14px; }
        .order-table th { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; border-top: 1px solid #dee2e6; color: #495057; font-weight: 600; padding: 12px 8px; text-align: center; white-space: nowrap; }
        .order-table td { padding: 8px 4px; border-bottom: 1px solid #f1f3f5; vertical-align: middle; }
        .table-input { width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; text-align: center; font-size: 14px; box-sizing: border-box; }
        .table-input:focus { border-color: #0d6efd; outline: none; }
        .table-input-readonly { background-color: transparent; border: none; font-weight: 600; color: #333; text-align: center; }
        .remove-row-btn { background-color: #fff; border: 1px solid #dc3545; color: #dc3545; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .remove-row-btn:hover { background-color: #dc3545; color: white; }
        .search-wrapper { display: flex; gap: 10px; margin-bottom: 10px; position: relative; }
        .search-results-box { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #0d6efd; border-radius: 4px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        /* 검색창 영역 전체 컨테이너 */
.search-container {
    display: flex;
    width: 100%; /* 부모 영역 꽉 채우기 */
    gap: 10px;   /* 인풋과 버튼 사이 간격 */
}

/* 인풋 필드를 감싸는 래퍼 (검색 결과창 위치 기준점) */
.search-input-wrapper {
    flex-grow: 1;       /* 남은 공간을 모두 차지하도록 설정 (핵심!) */
    position: relative; /* 검색 결과 드롭다운 위치 기준 */
}

/* 실제 인풋 창 */
.search-input-wrapper input {
    width: 100%;        /* 래퍼 안에서 꽉 차게 */
    box-sizing: border-box;
}

/* 검색 버튼 */
.search-btn {
    white-space: nowrap; /* 버튼 텍스트 줄바꿈 방지 */
    flex-shrink: 0;      /* 버튼 크기가 줄어들지 않도록 고정 */
}
    </style>
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <div style="font-size: 1.5em; font-weight: 700; margin-bottom: 40px; color: #007bff;">Wise Music Dashboard</div>
            <div class="sidebar-nav">
                <a href="{% url 'order_list' %}" class="nav-item">주문 목록</a>
                <a href="#" class="nav-item active">주문 수정</a>
                <a href="{% url 'book_list' %}" class="nav-item">책 관리</a>
                <a href="{% url 'reimbursement_base' %}" class="nav-item">정산 관리</a>
            </div>
        </nav>

        <main class="content">
            <h1 class="page-title">주문 수정 (#{{ order.id }})</h1>

            <div class="add-order-form">
                
                <form id="edit-order-form" onsubmit="submitEditOrder(event)">
                    {% csrf_token %}
                    
                    <div class="modal-header-layout">
                        <h2 class="modal-title">주문 정보 수정</h2>
                        <button class="save-button" type="submit">수정 내용 저장</button>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">배송 정보</div>
                        <div class="form-section-fields">
                            <div class="form-row-group">
                                <label for="customer_name" class="form-label">주문자명</label>
                                <input type="text" id="customer_name" name="customer_name" class="form-input" 
                                       value="{{ order.customer.name }}" required>
                            </div>
                            <div class="form-row-group">
                                <label for="contact" class="form-label">연락처</label>
                                <input type="text" id="contact" name="contact_number" class="form-input" 
                                       value="{{ order.customer.contact_number }}" required>
                            </div>
                            <div class="form-row-group">
                                <label for="address" class="form-label">주소</label>
                                <div class="address-stack">
                                    <div class="address-group">
                                        <input type="text" id="address" name="address" class="form-input" 
                                               value="{{ order.customer.address }}" readonly>
                                        <input type="hidden" id="zipcode" name="zipcode">
                                        <button type="button" class="search-btn"
                                                hx-post="{% url 'htmx_lookup_address_modal' %}"
                                                hx-target="#address-modal"
                                                hx-swap="innerHTML"
                                                hx-include="[name='customer_name'], [name='contact_number']"
                                                hx-indicator="#modal-loading">
                                            주소 변경
                                        </button>
                                    </div>
                                    <input type="text" id="address_detail" name="address_detail" class="form-input" 
                                        placeholder="상세주소 변경 시 입력" style="margin-top: 8px;">
                                </div>
                            </div>
                            <div class="form-row-group">
                                <label class="form-label">주문처 | 주문일</label>
                                <div class="input-group">
                                    <select name="order_source" class="form-select">
                                        <option value="website" {% if order.order_source == 'website' %}selected{% endif %}>웹사이트</option>
                                        <option value="phone" {% if order.order_source == 'phone' %}selected{% endif %}>전화</option>
                                        <option value="store" {% if order.order_source == 'store' %}selected{% endif %}>매장</option>
                                    </select>
                                    <input type="date" name="order_date" class="form-input" 
                                           value="{{ order.order_date|date:'Y-m-d' }}">   
                                </div>
                            </div>
                            <div class="form-row-group">
                                <label class="form-label">배송방법 | 배송일</label>
                                <div class="input-group">
                                    <select name="delivery_method" class="form-select"> 
                                        <option value="택배" {% if order.delivery_method == '택배' %}selected{% endif %}>택배</option>
                                        <option value="방문수령" {% if order.delivery_method == '방문수령' %}selected{% endif %}>방문 수령</option>
                                    </select>
                                    <input type="date" name="delivery_date" class="form-input" 
                                           value="{{ order.delivery_date|date:'Y-m-d'|default:'' }}"> 
                                </div>
                            </div>
                            <div class="form-row-group">
                                <label class="form-label">결제방법 | 결제일</label>
                                <div class="input-group">
                                    <select name="payment_method" class="form-select">
                                        {% for code, name in order.PAYMENT_CHOICES %}
                                            <option value="{{ code }}" {% if order.payment_method == code %}selected{% endif %}>{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                    <input type="date" name="payment_date" class="form-input" 
                                           value="{{ order.payment_date|date:'Y-m-d'|default:'' }}">
                                </div>
                            </div>
                            <div class="form-row-group">
                                <label for="request_memo" class="form-label">요청사항</label>
                                <textarea id="request_memo" name="requests" class="form-input textarea-input">{{ order.requests }}</textarea>
                            </div>
                        </div>
                    </div>

                    <hr class="section-divider">

                    <div class="form-section">
                        <h2 class="form-section-title" style="margin-top: 0;">상품 목록</h2>
                        
                        <div class="form-section-fields">
                            <div class="form-row-group">
                                <label class="form-label">상품 추가</label>
                                
                                <div style="flex: 1;">
                                    <div class="search-container">
                                        <div class="search-input-wrapper">
                                            <input type="hidden" id="current_book_id"> 
                                            <input type="text" id="item_name" name="item_name" class="form-input" 
                                                placeholder="추가할 책 제목을 검색하세요..."
                                                style="width: 100%;"
                                                onkeypress="if(event.keyCode==13){ document.getElementById('btn-search-book').click(); event.preventDefault(); }">
                                            <div id="search-results" class="search-results-box"></div>
                                        </div>
                                        <button type="button" id="btn-search-book" class="search-btn"
                                                hx-get="{% url 'api_order_book_search' %}"
                                                hx-trigger="click"
                                                hx-target="#search-results" hx-swap="innerHTML"
                                                hx-include="[name='item_name']">
                                            + 검색
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="order-table-wrapper">
                                <table class="order-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%;">상품명</th>
                                            <th style="width: 15%;">수량</th>
                                            <th style="width: 15%;">할인율(%)</th>
                                            <th style="width: 15%;">제본 수량</th>
                                            <th style="width: 20%;">공급가(합계)</th>
                                            <th style="width: 5%;">삭제</th>
                                        </tr>
                                    </thead>
                                    <tbody id="order-items-tbody">
                                        </tbody>
                                    <tfoot>
                                        <tr style="background-color: #fdfdfd; border-top: 2px solid #e9ecef;">
                                            <td colspan="4" style="text-align: right; font-weight: bold; padding-right: 15px;">총 주문 금액 :</td>
                                            <td style="padding: 10px;">
                                                <input type="text" id="total_order_price_display" 
                                                       class="table-input-readonly" 
                                                       style="text-align: right; width: 100%; color: #0d6efd; font-size: 1.1em;" 
                                                       value="0원" readonly>
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group-bottom">
                        <a href="{% url 'order_detail' order.id %}" class="cancel-button">취소</a>
                    </div>
                
                </form> 
            </div> 
            
            <div id="modal-loading" class="htmx-indicator">
                <div class="spinner"></div> 
            </div>
            <div id="modal-overlay" onclick="hideModal()">
                <div id="address-modal" class="modal-content" onclick="event.stopPropagation()"></div>
            </div>

        </main>
    </div> 

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script>
        let orderItems = []; 

        document.body.addEventListener('htmx:configRequest', (event) => {
            if (event.detail.verb === 'post') {
                event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
            }
        });

        // --- [ 1. 초기 데이터 로드 (Pre-fill Logic) ] ---
        document.addEventListener('DOMContentLoaded', function() {
            {% for item in order.order_items.all %}
                // 책 가격 히스토리가 없을 경우를 대비해 default 처리
                {% with history=item.book.price_histories.all.last %}
                
                orderItems.push({
                    // [중요] 따옴표로 감싸고 파싱하여 JS 오류 방지
                    book: parseInt("{{ item.book.id }}"),
                    bookTitle: "{{ item.book.title_korean|escapejs }}",
                    basePrice: parseFloat("{{ history.price|default:0 }}"), 
                    quantity: parseInt("{{ item.quantity }}"),
                    discount_rate: parseFloat("{{ item.discount_rate }}"),
                    additional_quantity: parseInt("{{ item.additional_quantity }}"),
                    total_price: parseInt("{{ item.total_price|default:0 }}") 
                });
                
                {% endwith %}
            {% endfor %}
            
            // 테이블 초기 렌더링
            renderOrderTable();
        });

        // --- [ 2. 테이블 로직 ] ---
        
        function selectBook(bookId, bookTitle, price) {
            const numericPrice = parseInt(price) || 0;
            const newItem = {
                book: bookId,
                bookTitle: bookTitle,
                basePrice: numericPrice,
                quantity: 1,
                discount_rate: 10.0,
                additional_quantity: 0,
                total_price: 0 
            };
            
            orderItems.push(newItem);
            calculateItemPrice(orderItems.length - 1);
            renderOrderTable();

            document.getElementById('item_name').value = '';
            document.getElementById('search-results').innerHTML = '';
        }

        function renderOrderTable() {
            const tbody = document.getElementById('order-items-tbody');
            if (orderItems.length === 0) {
                tbody.innerHTML = `<tr id="empty-row"><td colspan="6" style="text-align: center; padding: 20px; color: #999;">검색하여 상품을 추가해주세요.</td></tr>`;
                updateGrandTotal();
                return;
            }

            let html = '';
            orderItems.forEach((item, index) => {
                html += `
                    <tr>
                        <td>
                            <input type="text" class="table-input-readonly" value="${item.bookTitle}" readonly title="${item.bookTitle}">
                        </td>
                        <td>
                            <input type="number" class="table-input" min="1" 
                                   value="${item.quantity}" 
                                   onchange="updateItem(${index}, 'quantity', this.value)">
                        </td>
                        <td>
                            <input type="number" class="table-input" step="0.1" min="0" max="100" 
                                   value="${item.discount_rate}" 
                                   onchange="updateItem(${index}, 'discount_rate', this.value)">
                        </td>
                        <td>
                            <input type="number" class="table-input" min="0" 
                                   value="${item.additional_quantity}" 
                                   onchange="updateItem(${index}, 'additional_quantity', this.value)">
                        </td>
                        <td>
                            <input type="text" class="table-input-readonly" 
                                   style="text-align: right;"
                                   value="${item.total_price.toLocaleString('ko-KR')}원" readonly>
                        </td>
                        <td style="text-align: center;">
                            <button type="button" class="remove-row-btn" onclick="removeItem(${index})">삭제</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
            updateGrandTotal();
        }

        function updateItem(index, field, value) {
            let val = parseFloat(value);
            if (field === 'quantity' || field === 'additional_quantity') val = parseInt(value);
            
            if (isNaN(val) || val < 0) val = 0;
            if (field === 'quantity' && val < 1) val = 1; 

            orderItems[index][field] = val;
            calculateItemPrice(index);
            renderOrderTable();
        }

        function calculateItemPrice(index) {
            const item = orderItems[index];
            const discountedUnit = item.basePrice * (1 - (item.discount_rate / 100));
            const bookTotal = Math.round(discountedUnit * item.quantity);
            // [수정] 제본비 계산 로직 추가 (테이블 UI에 있으므로)
            
            item.total_price = bookTotal
        }

        function removeItem(index) {
            if (confirm("정말 삭제하시겠습니까?")) {
                orderItems.splice(index, 1);
                renderOrderTable();
            }
        }

        function updateGrandTotal() {
            const total = orderItems.reduce((sum, item) => sum + item.total_price, 0);
            document.getElementById('total_order_price_display').value = total.toLocaleString('ko-KR') + "원";
        }

        // --- [ 3. PATCH 전송 로직 (수정됨) ] ---
        async function submitEditOrder(event) {
            event.preventDefault(); 
            if (orderItems.length === 0) {
                alert("상품이 하나도 없습니다.");
                return;
            }
            const form = document.getElementById('edit-order-form');
            const formData = new FormData(form);
            
            const mainAddress = formData.get('address');
            const detailAddress = formData.get('address_detail');
            let fullAddress = mainAddress;
            
            // 상세주소가 입력된 경우에만 붙임
            if (detailAddress && detailAddress.trim() !== "") {
                fullAddress = `${mainAddress}, ${detailAddress}`;
            }

            const payload = {
                customer_info_data: {
                    name: formData.get('customer_name'),
                    address: fullAddress,
                    contact_number: formData.get('contact_number')
                },
                order_source: formData.get('order_source'),
                delivery_method: formData.get('delivery_method'), 
                payment_method: formData.get('payment_method'),
                payment_date: formData.get('payment_date') || null,
                delivery_date: formData.get('delivery_date') || null,
                requests: formData.get('requests'), 
                order_items: orderItems.map(item => ({
                    book: item.book,
                    quantity: item.quantity,
                    discount_rate: item.discount_rate,
                    additional_quantity: item.additional_quantity
                }))
            };

            try {
                // [수정] PATCH 메소드 및 수정 API URL 사용
                const response = await fetch("{% url 'order-api-detail' order.id %}", {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("수정이 완료되었습니다.");
                    window.location.href = "{% url 'order_detail' order.id %}";
                } else {
                    const errors = await response.json();
                    alert("저장 실패:\n" + JSON.stringify(errors, null, 2));
                }
            } catch (error) {
                console.error("오류:", error);
                alert("네트워크 오류가 발생했습니다.");
            }
        }

        // --- [ 4. 유틸리티 ] ---
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) { selectAddress(data.roadAddress, data.zonecode); }
            }).open();
        }

        function showModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
        function hideModal() { 
            document.getElementById('modal-overlay').style.display = 'none'; 
            document.getElementById('address-modal').innerHTML = '';
        }
        function selectAddress(address, zipcode) {
            document.getElementById('address').value = address;
            document.getElementById('zipcode').value = zipcode; 
            hideModal();
            document.getElementById('address_detail').focus();
        }

        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'address-modal') showModal();
        });

        document.addEventListener('click', function(event) {
            const searchContainer = document.querySelector('.search-wrapper');
            if (searchContainer && !searchContainer.contains(event.target)) {
                const searchResults = document.getElementById('search-results');
                if (searchResults) searchResults.innerHTML = '';
            }
        });
    </script>
</body>
</html>