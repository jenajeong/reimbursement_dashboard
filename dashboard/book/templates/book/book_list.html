{% extends "book/base.html" %}
{% load static %}

{% block title %}책 목록{% endblock %}

{% block content %}
<h1 class="page-title">책 관리</h1>

<div class="header">
    <div class="search-filter-section">
        <!-- [최적화] 폼의 hx-get URL을 'book_list'로 유지 (views.py의 book_list_view) -->
        <form id="search-form" 
              hx-get="{% url 'book_list' %}" 
              hx-target="#book-table-body" 
              hx-trigger="submit, keyup changed delay:300ms from:[name='search_query'], change from:select"
              hx-swap="innerHTML">
            
            <div class="search-box">
                <input type="search" name="search_query" placeholder="책제목 또는 저자명으로 검색" class="search-input" value="{{ search_query }}">
                <button class="search-button" type="submit">검색</button>
            </div>
            
            <div class="filter-box">
                <div class="source-filter">
                    <label for="category1">카테고리1:</label>
                    <!-- [최적화] Category 모델이 아닌 Book.category1을 사용 (views.py에서 categories1 전달) -->
                    <select class="source-select" id="category1" name="category1"
                            hx-get="{% url 'ajax_load_category2' %}"
                            hx-target="#category2"
                            hx-trigger="change">
                        <option value="">전체</option>
                        {% for cat1 in categories1 %}
                        <option value="{{ cat1 }}" {% if selected_category1 == cat1 %}selected{% endif %}>{{ cat1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="source-filter">
                    <label for="category2">카테고리2:</label>
                    <select class="source-select" id="category2" name="category2">
                        {% include 'book/partials/category2_options.html' %}
                    </select>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="content-header" style="display: flex; justify-content: flex-end; gap: 10px;">
    <!-- (기존) 책 추가 버튼 -->
    <a href="{% url 'add_book_page' %}" class="add-button">+ 책 추가</a>
    
    <a href="{% url 'batch_price_update' %}" 
       id="batch-update-btn"
       class="add-button-disabled">
       가격일괄변동
    </a>
</div>

<div id="book-table-container">
    <table class="order-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all-checkbox" title="전체 선택"></th>
                <th>책제목</th>
                <th>저자</th>
                <th>출판사</th>
                <th>카테고리</th>
                <th>가격</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="book-table-body">
            {% include 'book/partials/book_table_body.html' %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
    const $batchBtn = $('#batch-update-btn');
    const $tableBody = $('#book-table-body');
    const $selectAll = $('#select-all-checkbox');

    // 1. 개별 체크박스 클릭 시 버튼 상태 업데이트
    // HTMX가 테이블 바디를 교체하므로, 이벤트 위임을 사용
    $tableBody.on('change', '.book-checkbox', function() {
        updateButtonState();
    });

    // 2. 전체선택 체크박스 클릭 시
    $selectAll.on('change', function() {
        const isChecked = $(this).prop('checked');
        $tableBody.find('.book-checkbox').prop('checked', isChecked).trigger('change');
    });

    // 3. 버튼 상태 업데이트 함수
    function updateButtonState() {
        const selectedCount = $tableBody.find('.book-checkbox:checked').length;
        if (selectedCount > 0) {
            $batchBtn.removeClass('disabled');
        } else {
            $batchBtn.addClass('disabled');
        }
        
        // 전체선택 체크박스 상태도 동기화
        $selectAll.prop('checked', selectedCount > 0 && selectedCount === $tableBody.find('.book-checkbox').length);
    }

    // 4. 가격일괄변동 버튼 클릭 시 (URL에 ID 추가)
    $batchBtn.on('click', function(e) {
        e.preventDefault(); // 기본 링크 이동 방지
        
        const selectedIds = $tableBody.find('.book-checkbox:checked').map(function() {
            return $(this).val();
        }).get(); // [1, 3, 5]

        if (selectedIds.length === 0) {
            return; // 비활성화 상태면 작동 안함
        }

        const baseUrl = $(this).attr('href'); // /book/batch-price-update/
        // URL에 쿼리 파라미터로 ID 목록 추가
        window.location.href = baseUrl + '?ids=' + selectedIds.join(',');
    });

    // HTMX 로드 완료 후 버튼 상태 재확인 (검색/필터링 시)
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'book-table-body') {
            updateButtonState();
        }
    });

    // 초기 로드 시 버튼 상태 확인
    updateButtonState();
});
</script>
{% endblock %}
