{% extends "book/base.html" %}
{% load static %}

{% block title %}ì±… ì¶”ê°€{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/book/add_book.css' %}">
{% endblock %}


{% block content %}
<form method="POST">
    {% csrf_token %}
    <div class="content-header-form">
        <h1 class="page-title" style="margin-bottom: 0;">ì±… ì¶”ê°€</h1>
        <button type="submit" class="submit-btn">ë‚´ìš© ì €ì¥</button>
    </div>

    <div class="form-container">
        <h2 class="form-section-title">ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
        
        <div class="form-row">
            <label for="{{ book_form.title_korean.id_for_label }}">ì±… ì œëª© (í•œê¸€)</label>
            {{ book_form.title_korean }}
        </div>
        <div class="form-row">
            <label for="{{ book_form.title_original.id_for_label }}">ì±… ì œëª© (ì›ì–´)</label>
            {{ book_form.title_original }}
        </div>
        <div class="form-row">
            <label for="{{ book_form.authors.id_for_label }}">ì €ì</label>
            {{ book_form.authors }}
        </div>
        <div class="form-row">
            <label for="{{ book_form.publisher.id_for_label }}">ì¶œíŒì‚¬</label>
            {{ book_form.publisher }}
        </div>
        
        <div class="form-row">
            <label for="id_category1">ì¹´í…Œê³ ë¦¬</label>
            
            <div class="category-group">
                
                <select name="{{ book_form.category1.name }}" id="id_category1"
                        hx-get="{% url 'ajax_load_category2' %}"
                        hx-target="#id_category2"
                        hx-trigger="change">
                    {% for value, text in book_form.category1.field.choices %}
                        <option value="{{ value }}" {% if book_form.category1.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
                
                <select name="{{ book_form.category2.name }}" id="id_category2">
                    {% for value, text in book_form.category2.field.choices %}
                        <option value="{{ value }}" {% if book_form.category2.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if book_form.category1.errors %}<div class="error-message">{{ book_form.category1.errors.as_text }}</div>{% endif %}
            {% if book_form.category2.errors %}<div class="error-message">{{ book_form.category2.errors.as_text }}</div>{% endif %}
        </div>
        <div class="form-row">
            <label for="{{ book_form.current_price.id_for_label }}">ê°€ê²©</label>
            {{ book_form.current_price }}
        </div>
        <div class="form-row">
            <label>ì±… ì¢…ë¥˜</label>
            <div class="input-group book-type-group">
                {% for radio in book_form.book_type %}
                    {{ radio.tag }}
                    <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                {% endfor %}
            </div>
        </div>

        <h2 class="form-section-title" style="margin-top: 40px;">ì‘ê³¡ê°€ ì •ë³´</h2>

        <div class="composer-form-header form-row">
            <label>ì‘ê³¡ê°€</label>
            <div class="input-group">
                <span class="header-label">ì‘ê³¡ê°€ëª…</span>
                <span class="header-label">ìƒë…„ì›”ì¼</span>
                <span class="header-label">ê³¡ ìˆ˜</span>
                <span class="header-label">ì €ì‘ê¶Œë£Œ (%)</span>
                <span></span> </div>
        </div>

        {{ composer_formset.management_form }}
        <div id="composer-forms">
            {% for form in composer_formset %}
            <div class="composer-form form-row">
                <label>ì‘ê³¡ê°€ {{ forloop.counter }}</label>
                <div class="input-group">
                    {{ form.composer_name }}
                    {{ form.date_of_birth }}
                    {{ form.number_of_songs }}
                    {{ form.royalty_percentage }}
                    <button type="button" class="remove-composer-btn">ì‚­ì œ</button>
                </div>
                {{ form.id }}
            </div>
            {% endfor %}
        </div>
        <div style="text-align: right; margin-top: 15px;">
            <button type="button" id="add-composer-btn" class="add-composer-btn">+ ì‘ê³¡ê°€ ì¶”ê°€</button>
        </div>
    </div>
</form>
{% endblock %}


{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const composerFormsContainer = document.getElementById('composer-forms');
    const addComposerBtn = document.getElementById('add-composer-btn');
    const totalFormsInput = document.querySelector('input[name="composerwork_set-TOTAL_FORMS"]');

    // ì‘ê³¡ê°€ í–‰ ì¶”ê°€ ê¸°ëŠ¥
    addComposerBtn.addEventListener('click', function() {
        // í˜„ì¬ í¼ ê°œìˆ˜ë¥¼ ê°€ì ¸ì˜´ (ì˜ˆ: 1ê°œ ìˆìœ¼ë©´ formCountëŠ” 1)
        let formCount = composerFormsContainer.getElementsByClassName('composer-form').length;
        
        // ì²« ë²ˆì§¸ í¼ì„ í…œí”Œë¦¿ìœ¼ë¡œ ë³µì œ
        const newForm = composerFormsContainer.children[0].cloneNode(true);

        // nameê³¼ id ì†ì„±ì˜ ìˆ«ì(prefix)ë¥¼ í˜„ì¬ í¼ ê°œìˆ˜ì— ë§ê²Œ ë³€ê²½
        newForm.innerHTML = newForm.innerHTML.replace(/-0-/g, `-${formCount}-`);
        
        // ==== ğŸ‘‡ ìˆ˜ì •ëœ ë¶€ë¶„ START ==== //
        // ìƒˆë¡œ ì¶”ê°€ëœ í¼ì˜ ë¼ë²¨ í…ìŠ¤íŠ¸ë¥¼ ì˜¬ë°”ë¥¸ ìˆ«ìë¡œ ë³€ê²½
        const label = newForm.querySelector('label');
        if (label) {
            label.textContent = `ì‘ê³¡ê°€ ${formCount + 1}`;
        }
        // ==== ìˆ˜ì •ëœ ë¶€ë¶„ END ==== //

        // ìƒˆë¡œ ì¶”ê°€ëœ í¼ì˜ ì…ë ¥ í•„ë“œ ê°’ë“¤ì„ ëª¨ë‘ ë¹„ì›€
        newForm.querySelectorAll('input[type="text"], input[type="date"], input[type="number"]').forEach(input => {
            input.value = '';
        });
        
        // í™”ë©´ì— ìƒˆë¡œìš´ í¼ ì¶”ê°€
        composerFormsContainer.appendChild(newForm);
        
        // Formsetì˜ ì´ í¼ ê°œìˆ˜(TOTAL_FORMS)ë¥¼ 1 ì¦ê°€
        totalFormsInput.value = formCount + 1;
    });

    // ì‘ê³¡ê°€ í–‰ ì‚­ì œ ê¸°ëŠ¥ (ê¸°ì¡´ê³¼ ë™ì¼)
    composerFormsContainer.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-composer-btn')) {
            const formToDelete = e.target.closest('.composer-form');
            const deleteInput = formToDelete.querySelector('input[id$="-DELETE"]');
            
            if (deleteInput) {
                deleteInput.checked = true;
                formToDelete.style.display = 'none';
            } else {
                formToDelete.remove();
                totalFormsInput.value = composerFormsContainer.getElementsByClassName('composer-form').length;
            }
        }
    });
});
</script>
{% endblock %}