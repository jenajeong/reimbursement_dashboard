{% extends "book/base.html" %}
{% load static %}

{% block title %}가격 일괄 변동{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/book/add_book.css' %}">
<style>
    /* 폼 전체를 감싸고 중앙 정렬 */
    .batch-update-container {
        max-width: 800px; /* 폼의 최대 너비 */
        margin: 0 auto; /* 화면 중앙에 배치 */
        background-color: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    /* 폼 헤더 (제목 + 버튼) */
    .content-header-form {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 30px; /* 헤더와 내용 사이 여백 */
    }
    .page-title {
        font-size: 1.5em; 
        font-weight: 600; 
        margin: 0;
    }
    .save-button { /* '일괄 적용' 버튼 스타일 */
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background-color 0.2s;
    }
    .save-button:hover {
        background-color: #0056b3;
    }
    .save-button:disabled {
        background-color: #a0a0a0;
        cursor: not-allowed;
    }

    /* 폼 섹션 제목 (줄바꿈 방지) */
    .form-section-title {
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 15px;
        margin-top: 30px; /* 섹션 간 여백 */
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 10px;
        width: 100%; /* 너비 100% */
    }
    .form-section-title:first-of-type {
        margin-top: 0;
    }

    /* 폼 그룹 (레이블 + 입력칸) */
    .form-group {
        margin-bottom: 20px; /* 필드 간 여백 */
    }
    .form-group label {
        display: block; /* 레이블이 한 줄 전체 차지 */
        font-weight: 500;
        margin-bottom: 8px; /* 레이블과 입력칸 사이 여백 */
        color: #333;
    }
    
    /* 입력칸/선택칸 (반응형) */
    .form-input, .form-select {
        width: 100%; /* 부모 너비 100% */
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box; /* 패딩/테두리 포함 100% */
    }

    /* 선택된 책 목록 스타일 */
    .selected-books-list {
        list-style-type: none;
        padding-left: 0;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        background-color: #f8f9fa;
        width: 100%;
        box-sizing: border-box;
    }
    .selected-books-list li {
        padding: 5px 0;
        font-size: 0.9em;
    }

    /* 폼 하단 '일괄 적용' 버튼 영역 */
    .form-submit-actions {
        text-align: right;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

</style>
{% endblock %}

{% block content %}
<div class="batch-update-container">
    <form id="batch-update-form">
        {% csrf_token %}
        <div class="content-header-form">
            <h1 class="page-title">가격 일괄 변동</h1>
            </div>

        <h2 class="form-section-title">대상 책 (총 {{ selected_books.count }}권)</h2>
        
        <div class="form-group">
            <label>선택 목록</label>
            {% if selected_books %}
                <ul class="selected-books-list">
                    {% for book in selected_books %}
                    <li>{{ book.title_korean }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p style="color: #dc3545;">가격 변동 대상으로 선택된 책이 없습니다. 목록에서 다시 선택해주세요.</p>
            {% endif %}
            <input type="hidden" name="book_ids" id="id_book_ids" value="{{ book_ids_str }}">
        </div>

        <h2 class="form-section-title">변동 설정 (필수)</h2>

        <div class="form-group">
            <label for="id_update_type">조정 방식</label>
            <select name="update_type" id="id_update_type" class="form-select" required>
                <option value="amount">금액(원) 더하기 (예: 1000, -500)</option>
                <option value="percent">비율(%) 인상 (예: 10, -5)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="id_value">조정 값</label>
            <input type="number" name="value" id="id_value" placeholder="숫자 입력 (예: 1000 또는 10)" class="form-input" required>
        </div>

        <div class="form-submit-actions">
            <button type="submit" class="save-button" id="submit-api-btn">일괄 적용</button>
        </div>
    </form>
</div>

<div id="result-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <h3 id="modal-title"></h3>
        <pre id="modal-message"></pre>
        <button type="button" id="modal-close-btn">확인</button>
    </div>
</div>
{% endblock %}


{% block script %}
<script>
// --- CSRF 토큰 함수 ---
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// --- API 폼 전송 함수 ---
async function submitBatchUpdate() {
    const btn = document.getElementById('submit-api-btn');
    if (!btn) { console.error("Submit button not found!"); return; }
    
    btn.disabled = true;
    btn.textContent = '적용 중...';
    
    let data = {};
    try {
        const form = document.getElementById('batch-update-form');
        const formData = new FormData(form); 

        data = {
            book_ids: formData.get('book_ids') || "", 
            update_type: formData.get('update_type'),
            value: formData.get('value')
        };

        if (!data.update_type || !data.value) {
            throw new Error("조정 방식과 조정 값은 필수입니다.");
        }
        if (!data.book_ids) {
            throw new Error("대상 책이 없습니다. 목록에서 다시 선택해주세요.");
        }

    } catch (collectError) {
        showModal('입력 오류', collectError.message);
        if (btn) { btn.disabled = false; btn.textContent = '일괄 적용'; } 
        return; 
    }

    // API로 전송
    try {
        const response = await fetch("{% url 'batch_price_update_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });

        const responseData = await response.json(); 
        if (!response.ok) {
            throw responseData; 
        }

        showModal('성공', `총 ${responseData.updated_count}개 책의 가격을 성공적으로 변동했습니다.`);
        setTimeout(() => { window.location.href = "{% url 'book_list' %}"; }, 2000);

    } catch (error) {
        console.error('API Error:', error);
        let errorMessage = "가격 변동에 실패했습니다.\n";
        
        if (typeof error === 'object' && error !== null) { 
            for (const key in error) { errorMessage += `\n[${key}]: ${JSON.stringify(error[key])}`; }
        } else { errorMessage = `네트워크/서버 오류: ${error.message || error}`; }
        
        showModal('오류', errorMessage);
    } finally {
        if (btn) {
           btn.disabled = false;
           btn.textContent = '일괄 적용';
        }
    }
}

// --- 폼 제출 이벤트 리스너 ---
document.getElementById('batch-update-form').addEventListener('submit', function(e) {
    e.preventDefault(); 
    submitBatchUpdate();   
});


// --- 결과 모달 함수 (변경 없음) ---
const modal = document.getElementById('result-modal');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');
const modalCloseBtn = document.getElementById('modal-close-btn');

function showModal(title, message) {
    if (!modal || !modalTitle || !modalMessage || !modalCloseBtn) {
        console.error('Modal elements not found!');
        alert(`${title}: ${message}`); 
        return;
    }
    modalTitle.textContent = title;
    modalMessage.textContent = message; 
    modal.style.display = 'flex';
}

if(modalCloseBtn) {
    modalCloseBtn.onclick = function() {
        if(modal) modal.style.display = 'none';
    }
}
window.onclick = function(event) {
    if (event.target == modal) {
        if(modal) modal.style.display = 'none';
    }
}
</script>

<style>
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background-color: white;
        padding: 25px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-content h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.3em;
        color: #333;
    }
    .modal-content pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #eee;
        max-height: 300px;
        overflow-y: auto;
    }
    .modal-content #modal-close-btn {
        display: block;
        width: 100%;
        margin-top: 20px;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
    }
    .modal-content #modal-close-btn:hover {
        background-color: #0056b3;
    }
</style>
{% endblock %}