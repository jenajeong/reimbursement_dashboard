{% extends "book/base.html" %}
{% load static %}

{% block title %}ê°€ê²© ì¼ê´„ ë³€ë™{% endblock %}

{% block head %}
<!-- 'ì±… ì¶”ê°€' í¼ê³¼ ë™ì¼í•œ CSS ì‚¬ìš© -->
<link rel="stylesheet" href="{% static 'css/book/add_book.css' %}">
<style>
    /* ì„ íƒëœ ì±… ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .selected-books-list {
        list-style-type: none;
        padding-left: 0;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        background-color: #f8f9fa;
    }
    .selected-books-list li {
        padding: 5px 0;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<form id="batch-update-form">
    {% csrf_token %}
    <div class="content-header-form">
        <h1 class="page-title" style="margin-bottom: 0;">ê°€ê²© ì¼ê´„ ë³€ë™</h1>
        <button type="submit" class="submit-btn" id="submit-api-btn">ì¼ê´„ ì ìš©</button>
    </div>

    <div class="form-container">
        <!-- ğŸ‘‡ [ìˆ˜ì •] ì¹´í…Œê³ ë¦¬ í•„í„° -> ì„ íƒëœ ì±… ëª©ë¡ í‘œì‹œ -->
        <h2 class="form-section-title">ëŒ€ìƒ ì±… (ì´ {{ selected_books.count }}ê¶Œ)</h2>
        {% if selected_books %}
            <ul class="selected-books-list">
                {% for book in selected_books %}
                <li>{{ book.title_korean }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="color: #dc3545;">ê°€ê²© ë³€ë™ ëŒ€ìƒìœ¼ë¡œ ì„ íƒëœ ì±…ì´ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì—ì„œ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        {% endif %}
        
        <!-- ğŸ‘‡ [ì‹ ê·œ] ì„ íƒëœ ì±… ID ëª©ë¡ì„ ìˆ¨ê²¨ì§„ í•„ë“œë¡œ APIì— ì „ì†¡ -->
        <input type="hidden" name="book_ids" id="id_book_ids" value="{{ book_ids_str }}">


        <h2 class="form-section-title" style="margin-top: 40px;">ë³€ë™ ì„¤ì • (í•„ìˆ˜)</h2>

        <!-- ë³€ë™ ë°©ì‹ (ë³€ê²½ ì—†ìŒ) -->
        <div class="form-row">
            <label for="id_update_type">ì¡°ì • ë°©ì‹</label>
            <select name="update_type" id="id_update_type" style="max-width: 600px;" required>
                <option value="amount">ê¸ˆì•¡(ì›) ë”í•˜ê¸° (ì˜ˆ: 1000, -500)</option>
                <option value="percent">ë¹„ìœ¨(%) ì¸ìƒ (ì˜ˆ: 10, -5)</option>
            </select>
        </div>

        <!-- ë³€ë™ ê°’ (ë³€ê²½ ì—†ìŒ) -->
        <div class="form-row">
            <label for="id_value">ì¡°ì • ê°’</label>
            <input type="number" name="value" id="id_value" placeholder="ìˆ«ì ì…ë ¥ (ì˜ˆ: 1000 ë˜ëŠ” 10)" style="max-width: 600px;" required>
        </div>
    </div>
</form>

<!-- API ì „ì†¡ ê²°ê³¼ë¥¼ í‘œì‹œí•  ëª¨ë‹¬ (ë³€ê²½ ì—†ìŒ) -->
<div id="result-modal" class="modal-backdrop" style="display: none;">
    <!-- ... (ëª¨ë‹¬ HTML) ... -->
</div>
{% endblock %}


{% block script %}
<!-- API í¼ ì „ì†¡ / ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
// --- CSRF í† í° í•¨ìˆ˜ ---
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// --- API í¼ ì „ì†¡ í•¨ìˆ˜ ---
async function submitBatchUpdate() {
    const btn = document.getElementById('submit-api-btn');
    if (!btn) { console.error("Submit button not found!"); return; }
    
    btn.disabled = true;
    btn.textContent = 'ì ìš© ì¤‘...';
    
    let data = {};
    try {
        const form = document.getElementById('batch-update-form');
        const formData = new FormData(form); 

        data = {
            book_ids: formData.get('book_ids') || "", 
            update_type: formData.get('update_type'),
            value: formData.get('value')
        };

        if (!data.update_type || !data.value) {
            throw new Error("ì¡°ì • ë°©ì‹ê³¼ ì¡°ì • ê°’ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        }

    } catch (collectError) {
        showModal('ì…ë ¥ ì˜¤ë¥˜', collectError.message);
        if (btn) { btn.disabled = false; btn.textContent = 'ì¼ê´„ ì ìš©'; } 
        return; 
    }

    // APIë¡œ ì „ì†¡
    try {
        const response = await fetch("{% url 'batch_price_update_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });

        const responseData = await response.json(); 
        if (!response.ok) {
            throw responseData; // ì„œë²„ ì˜¤ë¥˜ (Serializer validation error ë“±)
        }

        // ì„±ê³µ
        showModal('ì„±ê³µ', `ì´ ${responseData.updated_count}ê°œ ì±…ì˜ ê°€ê²©ì„ ì„±ê³µì ìœ¼ë¡œ ë³€ë™í–ˆìŠµë‹ˆë‹¤.`);
        // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëª©ë¡ìœ¼ë¡œ ì´ë™
        setTimeout(() => { window.location.href = "{% url 'book_list' %}"; }, 2000);

    } catch (error) {
        // ì‹¤íŒ¨
        console.error('API Error:', error);
        let errorMessage = "ê°€ê²© ë³€ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n";
        
        if (error instanceof Error) {
            // JavaScript í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì˜¤ë¥˜ (e.g., new Error(...))
            errorMessage += error.message;
        } else if (typeof error === 'object' && error !== null) { 
            for (const key in error) {
                if (Array.isArray(error[key])) {
                    error[key].forEach(err => {
                        if (typeof err === 'object') {
                             errorMessage += `\n- ${key}: ${JSON.stringify(err)}`;
                        } else {
                             errorMessage += `\n- ${key}: ${err}`;
                        }
                    });
                } else {
                    errorMessage += `\n- ${key}: ${JSON.stringify(error[key])}`;
                }
            }
        } else { 
            // ê¸°íƒ€ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜
            errorMessage += "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
        
        showModal('ì˜¤ë¥˜', errorMessage);
    } finally {
        if (btn) {
           btn.disabled = false;
           btn.textContent = 'ì¼ê´„ ì ìš©';
        }
    }
}

// --- í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
document.getElementById('batch-update-form').addEventListener('submit', function(e) {
    e.preventDefault(); 
    submitBatchUpdate();   
});


// --- ê²°ê³¼ ëª¨ë‹¬ í•¨ìˆ˜ ---
const modal = document.getElementById('result-modal');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');
const modalCloseBtn = document.getElementById('modal-close-btn');

function showModal(title, message) {
    if (!modal || !modalTitle || !modalMessage || !modalCloseBtn) {
        console.error('Modal elements not found!');
        alert(`${title}: ${message}`); 
        return;
    }
    modalTitle.textContent = title;
    modalMessage.textContent = message; 
    modal.style.display = 'flex';
}

// ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ (ê¸°ë³¸ ë™ì‘)
if(modalCloseBtn) {
    modalCloseBtn.onclick = function() {
        if(modal) modal.style.display = 'none';
    }
}
// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = function(event) {
    if (event.target == modal) {
        if(modal) modal.style.display = 'none';
    }
}
</script>
{% endblock %}
