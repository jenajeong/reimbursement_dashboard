{% extends "book/base.html" %}
{% load static %}

{% block title %}ì±… ìˆ˜ì •: {{ book.title_korean }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/book/add_book.css' %}">
{% endblock %}

{% block content %}
<!-- [ìˆ˜ì •] í¼ íƒœê·¸ì— data-composer-count ì†ì„± ì¶”ê°€ -->
<form id="add-book-form" data-book-id="{{ book.pk }}" data-composer-count="{{ composer_works|length|default:1 }}">
    {% csrf_token %}
    <div class="content-header-form">
        <h1 class="page-title" style="margin-bottom: 0;">ì±… ìˆ˜ì •</h1>
        <button type="submit" class="submit-btn" id="submit-api-btn">ë‚´ìš© ì €ì¥</button>
    </div>

    <div class="form-container">
        <h2 class="form-section-title">ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
        
        <!-- 1. ì±… ì œëª© (Select2 - ë°ì´í„° ë¯¸ë¦¬ ì±„ìš°ê¸°) -->
        <div class="form-row">
            <label for="id_title_korean">ì±… ì œëª© (í•œê¸€)</label>
            <select name="title_korean" id="id_title_korean" style="width: 100%; max-width: 600px;" required>
                <!-- ë·°ì—ì„œ ì „ë‹¬ëœ ê°’ìœ¼ë¡œ <option> ë¯¸ë¦¬ ìƒì„± -->
                <option value="{{ book.title_korean }}" selected>{{ book.title_korean }}</option>
            </select>
        </div>
        
        <!-- 2. ì±… ì œëª© (ì›ì–´) -->
        <div class="form-row">
            <label for="id_title_original">ì±… ì œëª© (ì›ì–´)</label>
            <input type="text" name="title_original" id="id_title_original" style="max-width: 600px;" value="{{ book.title_original|default:'' }}">
        </div>

        <!-- 3. ì €ì (Select2 - ë°ì´í„° ë¯¸ë¦¬ ì±„ìš°ê¸°) -->
        <div class="form-row">
            <label for="id_authors">ì €ì</label>
            <select name="authors" id="id_authors" multiple="multiple" style="width: 100%; max-width: 600px;">
                <!-- ë·°ì—ì„œ ì „ë‹¬ëœ ê°’ìœ¼ë¡œ <option> ë¯¸ë¦¬ ìƒì„± -->
                {% for author in book.authors.all %}
                <option value="{{ author.name }}" selected>{{ author.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- 4. ì¶œíŒì‚¬ -->
        <div class="form-row">
            <label for="id_publisher">ì¶œíŒì‚¬</label>
            <input type="text" name="publisher" id="id_publisher" value="{{ book.publisher|default:'ì™€ì´ì¦ˆì„±ê°€' }}" style="max-width: 600px;">
        </div>
        
        <!-- 5. ì¹´í…Œê³ ë¦¬ (Select2 - ë°ì´í„° ë¯¸ë¦¬ ì±„ìš°ê¸°) -->
        <div class="form-row">
            <label for="id_category1">ì¹´í…Œê³ ë¦¬</label>
            <div class="category-group">
                <select name="category1" id="id_category1" style="width: 50%;" required>
                    <option value="{{ book.category1 }}" selected>{{ book.category1 }}</option>
                </select>
                <select name="category2" id="id_category2" style="width: 50%;" required>
                    <option value="{{ book.category2 }}" selected>{{ book.category2 }}</option>
                </select>
            </div>
        </div>

        <!-- 6. ê°€ê²© -->
        <div class="form-row">
            <label for="id_current_price">ê°€ê²©</label>
            <input type="number" name="current_price" id="id_current_price" value="{{ current_price|default:0 }}" min="0" required>
        </div>

        <!-- 7. ì±… ì¢…ë¥˜ -->
        <div class="form-row">
            <label>ì±… ì¢…ë¥˜</label>
            <div class="input-group book-type-group">
                <input type="radio" name="book_type" id="id_book_type_1" value="ì¼ë°˜" {% if book.book_type == 'GEN' or not book.book_type %}checked{% endif %}>
                <label for="id_book_type_1">ì¼ë°˜</label>
                <input type="radio" name="book_type" id="id_book_type_2" value="í”¼ìŠ¤" {% if book.book_type == 'PCS' %}checked{% endif %}>
                <label for="id_book_type_2">í”¼ìŠ¤</label>
                <input type="radio" name="book_type" id="id_book_type_3" value="ì´ë³´" {% if book.book_type == 'SCO' %}checked{% endif %}>
                <label for="id_book_type_3">ì´ë³´</label>
            </div>
        </div>

        <!-- 8. ì‘ê³¡ê°€ ì •ë³´ (ë°ì´í„° ë¯¸ë¦¬ ì±„ìš°ê¸°) -->
        <h2 class="form-section-title" style="margin-top: 40px;">ì‘ê³¡ê°€ ì •ë³´</h2>
        <div class="composer-form-header form-row">
            <label>ì‘ê³¡ê°€</label>
            <div class="input-group">
                <span class="header-label">ì‘ê³¡ê°€ëª… (í•„ìˆ˜)</span>
                <span class="header-label">ìƒë…„ì›”ì¼ (í•„ìˆ˜)</span>
                <span class="header-label">ê³¡ ìˆ˜ (í•„ìˆ˜)</span>
                <span class="header-label">ì €ì‘ê¶Œë£Œ (%) (í•„ìˆ˜)</span>
                <span></span> 
            </div>
        </div>

        <div id="composer-forms-container">
            <!-- ë·°ì—ì„œ ì „ë‹¬ëœ composer_works ë£¨í”„ -->
            {% for work in composer_works %}
            <div class="composer-form form-row" data-index="{{ forloop.counter0 }}">
                <label>ì‘ê³¡ê°€ {{ forloop.counter }}</label>
                <div class="input-group">
                    <input type="text" name="composer_name" placeholder="ì‘ê³¡ê°€ëª… (í•„ìˆ˜)" value="{{ work.composer.name }}" required>
                    <input type="date" name="date_of_birth" value="{{ work.composer.date_of_birth|date:'Y-m-d' }}" required>
                    <input type="number" name="number_of_songs" placeholder="ê³¡ ìˆ˜ (í•„ìˆ˜)" value="{{ work.number_of_songs }}" min="1" required>
                    <input type="number" name="royalty_percentage" placeholder="% (í•„ìˆ˜)" step="0.01" value="{{ work.royalty_percentage }}" min="0" required>
                    <button type="button" class="remove-composer-btn" onclick="removeComposerRow(this)">ì‚­ì œ</button>
                </div>
            </div>
            {% empty %}
            <!-- ì‘ê³¡ê°€ê°€ í•œ ëª…ë„ ì—†ìœ¼ë©´ 'ì¶”ê°€' í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ë¹ˆ 1í–‰ í‘œì‹œ -->
            <div class="composer-form form-row" data-index="0">
                <label>ì‘ê³¡ê°€ 1</label>
                <div class="input-group">
                    <input type="text" name="composer_name" placeholder="ì‘ê³¡ê°€ëª… (í•„ìˆ˜)">
                    <input type="number" name="number_of_songs" placeholder="ê³¡ ìˆ˜ (í•„ìˆ˜)" value="1" min="1">
                    <input type="number" name="royalty_percentage" placeholder="% (í•„ìˆ˜)" step="0.01" value="10.0" min="0">
                    <button type="button" class="remove-composer-btn" onclick="removeComposerRow(this)">ì‚­ì œ</button>
                </div>
            </div>
            {% endfor %}
        </div>
        <div style="text-align: right; margin-top: 15px;">
            <button type="button" id="add-composer-btn" class="add-composer-btn" onclick="addComposerRow()">+ ì‘ê³¡ê°€ ì¶”ê°€</button>
        </div>
    </div>
</form>

<!-- ëª¨ë‹¬ HTML (ë³€ê²½ ì—†ìŒ) -->
<div id="result-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <h3 id="modal-title"></h3>
        <pre id="modal-message"></pre>
        <button type="button" id="modal-close-btn">í™•ì¸</button>
    </div>
</div>
{% endblock %}


{% block script %}
<!-- 1. Select2 ì´ˆê¸°í™” (ë°ì´í„°ê°€ ë¯¸ë¦¬ ì±„ì›Œì ¸ ìˆìœ¼ë¯€ë¡œ, AJAX ë¡œì§ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©) -->
<script>
$(document).ready(function() {
    
    $('#id_title_korean').select2({
        width: '100%', placeholder: 'ì±… ì œëª©ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ìƒˆë¡œ ì…ë ¥í•˜ì„¸ìš”', allowClear: true, tags: true, 
        ajax: { url: "{% url 'ajax_search_book_titles' %}", dataType: 'json', delay: 250, data: function (params) { return { term: params.term }; }, processResults: function (data) { return { results: data.results }; }, cache: true }
    });
    $('#id_authors').select2({
        width: '100%', placeholder: 'ì €ì ì´ë¦„ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ìƒˆë¡œ ì…ë ¥í•˜ì„¸ìš”', allowClear: true, tags: true, 
        ajax: { url: "{% url 'ajax_search_authors' %}", dataType: 'json', delay: 250, data: function (params) { return { term: params.term }; }, processResults: function (data) { return { results: data.results }; }, cache: true }
    });
    $('#id_category1').select2({
        width: '100%', placeholder: '1ì°¨ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰/ì…ë ¥', allowClear: true, tags: true, 
        ajax: { url: "{% url 'ajax_search_category1' %}", dataType: 'json', delay: 250, data: function (params) { return { term: params.term }; }, processResults: function (data) { return { results: data.results }; }, cache: true }
    });
    $('#id_category2').select2({
        width: '100%', placeholder: '2ì°¨ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰/ì…ë ¥', allowClear: true, tags: true, 
        ajax: { url: "{% url 'ajax_search_category2' %}", dataType: 'json', delay: 250, data: function (params) { return { term: params.term, category1: $('#id_category1').val() }; }, processResults: function (data) { return { results: data.results }; }, cache: true }
    });
    $('#id_category1').on('select2:select select2:unselect select2:clear', function (e) {
        $('#id_category2').val(null).trigger('change');
    });
});
</script>

<!-- 2. API í¼ ì „ì†¡ / ë™ì  ì‘ê³¡ê°€ í¼ / ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ (ìˆ˜ì •ë¨) -->
<script>
// --- CSRF í† í° í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ) ---
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// --- ë™ì  ì‘ê³¡ê°€ í¼ í•¨ìˆ˜ (ìˆ˜ì •) ---
const formElement = document.getElementById('add-book-form');
// ğŸ‘‡ [ìˆ˜ì •] í…œí”Œë¦¿ íƒœê·¸ ëŒ€ì‹  data ì†ì„±ì—ì„œ ê°’ì„ ì½ì–´ì˜´ (ë¹¨ê°„ ë°‘ì¤„ ì œê±°)
let composerIndex = parseInt(formElement.dataset.composerCount, 10);
if (isNaN(composerIndex) || composerIndex === 0) {
    composerIndex = 1; // ë·°ì—ì„œ 0ì„ ë°˜í™˜í–ˆê±°ë‚˜(ì‘ê³¡ê°€ ì—†ìŒ) 1í–‰ì´ ë Œë”ë§ëœ ê²½ìš°
}

function addComposerRow() {
    const container = document.getElementById('composer-forms-container');
    // [ìˆ˜ì •] newIndex ê³„ì‚° ë°©ì‹ì„ composerIndex++ (í›„ì¦ê°€) -> ++composerIndex (ì „ì¦ê°€) ë˜ëŠ”
    // í˜„ì¬ í–‰ì˜ ê°œìˆ˜ë¥¼ ì„¸ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½
    let currentCount = container.getElementsByClassName('composer-form').length;
    composerIndex = currentCount; // í˜„ì¬ ê°œìˆ˜ë¡œ ì¸ë±ìŠ¤ ë™ê¸°í™”

    const newIndex = composerIndex; // ìƒˆ ì¸ë±ìŠ¤ëŠ” í˜„ì¬ ê°œìˆ˜ (0ë¶€í„° ì‹œì‘í•˜ë©´ newIndex = composerIndex++)
    
    const firstForm = container.querySelector('.composer-form');
    if (!firstForm) return; 
    const newForm = firstForm.cloneNode(true);
    newForm.dataset.index = newIndex;

    const label = newForm.querySelector('label');
    if (label) {
        label.textContent = `ì‘ê³¡ê°€ ${newIndex + 1}`; // 0-based index -> 1-based label
    }

    // ìƒˆ í–‰ì˜ ì…ë ¥ í•„ë“œ ê°’ ì´ˆê¸°í™”
    newForm.querySelector('input[name="composer_name"]').value = '';
    newForm.querySelector('input[name="number_of_songs"]').value = '1';
    newForm.querySelector('input[name="royalty_percentage"]').value = '10.0';
    
    container.appendChild(newForm);
    // composerIndex++; // addComposerRowê°€ í˜¸ì¶œë  ë•Œë§ˆë‹¤ 1ì”© ì¦ê°€
}
function removeComposerRow(button) {
    const container = document.getElementById('composer-forms-container');
    const formToRemove = button.closest('.composer-form');
    if (container.children.length > 1) {
        formToRemove.remove();
        updateComposerLabels();
        // composerIndex--; // ì¸ë±ìŠ¤ë¥¼ ë‹¤ì‹œ ê³„ì‚°í•˜ë¯€ë¡œ -- ë¶ˆí•„ìš”
    } else {
        formToRemove.querySelector('input[name="composer_name"]').value = '';
        formToRemove.querySelector('input[name="number_of_songs"]').value = '1';
        formToRemove.querySelector('input[name="royalty_percentage"]').value = '10.0';
    }
}
function updateComposerLabels() {
    const forms = document.querySelectorAll('#composer-forms-container .composer-form');
    forms.forEach((form, index) => {
        form.querySelector('label').textContent = `ì‘ê³¡ê°€ ${index + 1}`;
    });
    // [ìˆ˜ì •] í˜„ì¬ í–‰ì˜ ê°œìˆ˜ë¡œ composerIndex ì—…ë°ì´íŠ¸
    composerIndex = forms.length;
}

// --- API í¼ ì „ì†¡ í•¨ìˆ˜ (POST -> PATCH) ---
async function submitBookForm() {
    const btn = document.getElementById('submit-api-btn');
    const form = document.getElementById('add-book-form');
    const bookId = form.dataset.bookId; 
    
    if (!btn || !bookId) { 
        console.error("Submit button or Book ID not found!"); 
        showModal('ì˜¤ë¥˜', 'í¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); 
        return; 
    }
    
    btn.disabled = true;
    btn.textContent = 'ìˆ˜ì • ì¤‘...';
    
    let data = {};
    try {
        const formData = new FormData(form); 
        const priceValue = formData.get('current_price');
        const priceInt = parseInt(priceValue, 10);
        if (isNaN(priceInt) || priceInt < 0) { throw new Error("ê°€ê²©ì€ 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤."); }

        data = {
            title_korean: ($('#id_title_korean').val() || "").trim(), 
            title_original: (formData.get('title_original') || "").trim(),
            publisher: (formData.get('publisher') || "ì™€ì´ì¦ˆì„±ê°€").trim(),
            book_type: formData.get('book_type') || "ì¼ë°˜",
            authors: $('#id_authors').select2('data').map(item => item.text.trim()).filter(name => name) || [], 
            category1: ($('#id_category1').val() || "").trim(), 
            category2: ($('#id_category2').val() || "").trim(), 
            initial_price_history: [{ price: priceInt, price_updated_at: new Date().toISOString() }],
            composers_data: [] 
        };

        const composerForms = document.querySelectorAll('#composer-forms-container .composer-form');
        let composerRowError = null;
        
        composerForms.forEach((formRow, index) => { 
            const composerNameInput = formRow.querySelector('input[name="composer_name"]');
            const dobInput = formRow.querySelector('input[name="date_of_birth"]');
            const songsInput = formRow.querySelector('input[name="number_of_songs"]');
            const royaltyInput = formRow.querySelector('input[name="royalty_percentage"]');

            if (!composerNameInput || !dobInput || !songsInput || !royaltyInput) {
                console.error(`Row ${index}: Composer form inputs missing!`);
                return;
            }

            const composerName = composerNameInput.value.trim();
            const dob = dobInput.value;
            const songs = songsInput.value;
            const royalty = royaltyInput.value;

            // [ìˆ˜ì •] ê¸°ë³¸ê°’ì´ê±°ë‚˜ ë¹ˆ í–‰ì€ ë¬´ì‹œ
            if (!composerName && !dob && (songs === '1' || !songs) && (royalty === '10.0' || !royalty)) {
                return; 
            }
            
            if (!composerName) { composerRowError = `ì‘ê³¡ê°€ ${index + 1} í–‰ì˜ 'ì‘ê³¡ê°€ëª…'ì´(ê°€) ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`; return; }
            if (!dob || dob === '1900-01-01') { composerRowError = `ì‘ê³¡ê°€ ${index + 1} í–‰ì˜ 'ìƒë…„ì›”ì¼'ì´(ê°€) ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`; return; }
            if (!songs) { composerRowError = `ì‘ê³¡ê°€ ${index + 1} í–‰ì˜ 'ê³¡ ìˆ˜'ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`; return; }
            if (!royalty) { composerRowError = `ì‘ê³¡ê°€ ${index + 1} í–‰ì˜ 'ì €ì‘ê¶Œë£Œ'ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`; return; }

            const numSongs = parseInt(songs, 10);
            const numRoyalty = parseFloat(royalty);
            if (isNaN(numSongs) || numSongs < 1) { composerRowError = `ì‘ê³¡ê°€ ${index + 1} í–‰ì˜ 'ê³¡ ìˆ˜'ëŠ” 1 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.`; return; }
            if (isNaN(numRoyalty) || numRoyalty < 0) { composerRowError = `ì‘ê³¡ê°€ ${index + 1} í–‰ì˜ 'ì €ì‘ê¶Œë£Œ'ëŠ” 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.`; return; }

            data.composers_data.push({
                 name: composerName,
                 date_of_birth: dob, 
                 number_of_songs: numSongs,
                 royalty_percentage: numRoyalty
            });
        });

        if (composerRowError) { throw new Error(composerRowError); }
        
        if (!data.title_korean) throw new Error("ì±… ì œëª©(í•œê¸€)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        if (!data.authors || data.authors.length === 0) throw new Error("ì €ìëŠ” ìµœì†Œ 1ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.");
        if (!data.category1) throw new Error("1ì°¨ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        if (!data.category2) throw new Error("2ì°¨ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
        if (!data.composers_data || data.composers_data.length === 0) throw new Error("ìœ íš¨í•œ ì‘ê³¡ê°€ ì •ë³´ê°€ ìµœì†Œ 1ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.");

    } catch (collectError) {
        showModal('ì…ë ¥ ì˜¤ë¥˜', collectError.message || 'í¼ ë°ì´í„° ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        if (btn) { btn.disabled = false; btn.textContent = 'ë‚´ìš© ì €ì¥'; } 
        return; 
    }

    // 2. APIë¡œ ì „ì†¡ (POST -> PATCH)
    try {
        const response = await fetch("{% url 'book-api-detail' book.pk %}", {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });

        const responseData = await response.json(); 
        if (!response.ok) {
            throw responseData;
        }

        window.location.href = "{% url 'book_detail' book.pk %}";

    } catch (error) {
        console.error('API Error:', error);
        let errorMessage = "ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n";
        if (typeof error === 'object' && !(error instanceof TypeError)) { 
            for (const key in error) { errorMessage += `\n[${key}]: ${JSON.stringify(error[key])}`; }
        } else { errorMessage = `ë„¤íŠ¸ì›Œí¬/ì„œë²„ ì˜¤ë¥˜: ${error.message || error}`; }
        errorMessage += "\n\n--- ì „ì†¡ ì‹œë„ ë°ì´í„° ---\n" + JSON.stringify(data, null, 2); 
        showModal('ì˜¤ë¥˜', errorMessage);

    } finally {
        if (btn) {
           btn.disabled = false;
           btn.textContent = 'ë‚´ìš© ì €ì¥';
        }
    }
}

// --- í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
document.getElementById('add-book-form').addEventListener('submit', function(e) {
    e.preventDefault(); 
    submitBookForm();   
});


// --- ê²°ê³¼ ëª¨ë‹¬ í•¨ìˆ˜ ---
const modal = document.getElementById('result-modal');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');
const modalCloseBtn = document.getElementById('modal-close-btn');

function showModal(title, message) {
    if (!modal || !modalTitle || !modalMessage || !modalCloseBtn) {
        console.error('Modal elements not found!');
        alert(`${title}: ${message}`); 
        return;
    }
    modalTitle.textContent = title;
    modalMessage.textContent = message; 
    modal.style.display = 'flex';
}
if(modalCloseBtn) {
    modalCloseBtn.onclick = function() {
        if(modal) modal.style.display = 'none';
    }
}
window.onclick = function(event) {
    if (event.target == modal) {
        if(modal) modal.style.display = 'none';
    }
}
</script>
{% endblock %}
